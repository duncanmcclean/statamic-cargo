{{#
    Displays the "Billing Address" step in the Checkout process.
#}}

{{ partial:checkout/components/step title="Billing Address" x-data="BillingAddressStep" }}
    {{ if {cart:has_physical_products} }}
        <label for="use_shipping_address_for_billing" class="flex items-center cursor-pointer">
            <input type="checkbox" id="use_shipping_address_for_billing" name="use_shipping_address_for_billing" x-model="useShippingAddressForBilling" class="rounded text-secondary focus:ring-secondary h-4 w-4">
            <span class="ml-2 font-medium text-gray-700 select-none">{{ 'Use shipping address for billing' | trans }}</span>
        </label>
    {{ /if }}

    <!-- We'll use hidden inputs to fall back to the shipping address if the user chooses to use it for billing. -->
    <template x-if="useShippingAddressForBilling">
        <div>
            <input type="hidden" name="billing_address[name]" :value="cart.shipping_address?.name">
            <input type="hidden" name="billing_address[line_1]" :value="cart.shipping_address?.line_1">
            <input type="hidden" name="billing_address[line_2]" :value="cart.shipping_address?.line_2">
            <input type="hidden" name="billing_address[city]" :value="cart.shipping_address?.city">
            <input type="hidden" name="billing_address[postcode]" :value="cart.shipping_address?.postcode">
            <input type="hidden" name="billing_address[state]" :value="cart.shipping_address?.state?.code">
            <input type="hidden" name="billing_address[country]" :value="cart.shipping_address?.country?.value">
        </div>
    </template>

    <!-- Otherwise, we'll show the billing address fields. -->
    <template x-if="! useShippingAddressForBilling">
        <div class="{{ if {cart:has_physical_products} }} mt-4 {{ /if }}">
            {{ partial:checkout/components/address type="billing" }}
        </div>
    </template>

    {{ slot:footer }}
        {{ partial:checkout/components/button label="Continue â†’" type="submit" }}
    {{ /slot:footer }}
{{ /partial:checkout/components/step }}

{{ push:footer_scripts }}
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('BillingAddressStep', () => ({
                useShippingAddressForBilling: {{ {cart:has_physical_products} ? 'true' : 'false' }},

                init() {
                    // When the cart has a shipping address AND billing address, check if they're different.
                    // If they are, uncheck the "Use shipping address for billing" checkbox.
                    // If they're not, keep it checked.
                    if (
                        this.cart.has_physical_products
                        && this.cart.shipping_address?.line_1
                        && this.cart.billing_address?.line_1
                    ) {
                        let shippingAddress = {
                            name: this.cart.shipping_address?.name,
                            line_1: this.cart.shipping_address?.line_1,
                            line_2: this.cart.shipping_address?.line_2,
                            city: this.cart.shipping_address?.city,
                            postcode: this.cart.shipping_address?.postcode,
                            state: this.cart.shipping_address?.state?.code,
                            country: this.cart.shipping_address?.country?.value,
                        };

                        let billingAddress = {
                            name: this.cart.billing_address?.name,
                            line_1: this.cart.billing_address?.line_1,
                            line_2: this.cart.billing_address?.line_2,
                            city: this.cart.billing_address?.city,
                            postcode: this.cart.billing_address?.postcode,
                            state: this.cart.billing_address?.state?.code,
                            country: this.cart.billing_address?.country?.value,
                        };

                        this.useShippingAddressForBilling = JSON.stringify(shippingAddress) === JSON.stringify(billingAddress);
                    }
                },
            }));
        });
    </script>
{{ /push:footer_scripts }}
